<html>
    <head>
        <title>LampLight</title>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Libre+Baskerville|Lato">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
        <script type="text/javascript" src="anime.min.js"></script>
        <script type="text/javascript" src="jquery-3.3.1.min.js"></script>
        <script type="text/javascript" src="jquery-ui-1.12.1.min.js"></script>
        <script type="text/javascript" src="jquery.ui.touch-punch.min.js"></script>
        <script type="text/javascript" src="Chart.min.js"></script>
        <meta name='viewport' content='width=device-width, initial-scale=0.66, maximum-scale=1.25' />
        <link type="image/png" rel="shortcut icon" href="lamplight.png" />
        <link type="text/css" href="lamplight.css" rel="stylesheet"  media="all">
    </head>
    <body>
        <div id="word-info">
            <div id="details"></div>
            <svg id="line-container">
              <line x1="0" y1="0" x2="0" y2="200" class="line" id="pointer-line"></line>
              <line x1="0" y1="0" x2="40" y2="0" class="line" ></line>
            </svg>
            <div id="dot"></div>
        </div>
        <div id="top_content"></div>
        <div id="verse_container">
            <div id="verse_loc"><div id="book_name" class="top_line_detail"></div><div id="chapter_verse" class="bottom_line_detail"></div></div>
            <div id="main_verse"></div>
        </div>
        <div id="search_outer">
            <div id="search_container">
                <div id="breadcrumb"></div>
                <input type="search" id="question" placeholder="You have questions, the Bible has answers..." autofocus="" maxlength="90" />
                <div id="search_icon_holder">
                    <i class="fa fa-circle-thinner fa-search" id="search_btn"></i>
                </div>
            </div>
            <div id="scrubber"></div>
            <div id="search_rooster">View Search Results</div>
        </div>
        <div id="options">
            <div id="error">No Results</div>
            <canvas id="chart1" width="260px" height="96px"></canvas>
            <div id="chart2" class="chart_item"></div>
            <div id="chart3" class="chart_item"></div>
        </div>
        <div id="tab_list"></div>
        <div id="tab_scrub_holder"><div id="tab_scrubber"></div></div>
        <div id="sel_list"></div>
        <div id="page_list"></div>
        <div id="footer" style="height:100px"></div>

        <script>
        (function() {
            searcher = {}

            $( "#search_btn" ).hover(
                function() {
                    var cssProperties = anime({
                        targets: ['.fa-circle-thinner'],
                        borderColor: 'rgba(211,211,211, 1)',
                        borderWidth: '2px',
                        duration: 200,
                        easing: 'linear'
                    });
                }, function() {
                    var cssProperties = anime({
                        targets: ['.fa-circle-thinner'],
                        borderColor: 'rgba(211,211,211, 0)',
                        borderWidth: '5px',
                        duration: 100,
                        easing: 'linear'
                    });
                }
            );

            $( "#search_icon_holder" ).off('click').click(
                function() {
                    var basicTimeline = anime.timeline();
                    basicTimeline
                        .add({
                            targets: ['.fa-circle-thinner'],
                            backgroundColor: offColorStringify(0.3),
                            color: 'rgb(255, 255, 255)',
                            duration: 100,
                            easing: 'linear'
                        })
                        .add({
                            targets: ['.fa-circle-thinner'],
                            backgroundColor: 'rgb(255, 255, 255)',
                            color: 'rgb(211, 211, 211)',
                            duration: 50,
                            easing: 'linear'
                        })


                    if(hint_list.length <= 0)
                    {
                        var q = $( "#question" ).val().trim();
                        if(q != "")
                        {
                            doSearch(q);
                	    }
                        else
                        {
                            enableTextSearch();
                        }
                    }
                    else
                    {
                        // if we are adding a text search and we cancel,
                        // we should re-show the breadcrumb
                        if($( "#breadcrumb" ).is(":visible"))
                        {
                            enableTextSearch();
                        }
                        else
                        {
                            enableHintView();
                        }
                    }
                }
            );

            function setCaretPosition(caretPos)
            {
                var elem = document.getElementById('question');
                var range;
                if (elem.createTextRange)
                {
                    range = elem.createTextRange();
                    range.move('character', caretPos);
                    range.select();
                }
                else
                {
                    elem.focus();
                    if (elem.selectionStart !== undefined)
                    {
                        elem.setSelectionRange(caretPos, caretPos);
                    }
                }
            }

            function resetHints()
            {
                hint_list = []
                enableTextSearch();
            }

            function enableTextSearch()
            {
                if(hint_list.length <= 0)
                {
                    $( "#search_btn" ).removeClass('fas')
                                      .removeClass('fa-plus-circle')
                                      .addClass('fa').addClass('fa-search');
                    $( "#question" ).attr("placeholder", "You have questions, the Bible has answers...");
                }
                else
                {
                    $( "#search_btn" ).removeClass('fas')
                                      .removeClass('fa-plus-circle')
                                      .addClass('fas').addClass('fa-times-circle');
                    $( "#question" ).attr("placeholder", "Add to search...");
                }

                $( "#breadcrumb" ).hide();
                $( "#scrubber" ).hide();
                $( "#question" ).val("").css("color", "grey").show().focus();
                setCaretPosition(0);
            }

            function enableHintView()
            {
                $( "#question" ).hide().val("");
                $( "#search_btn" ).removeClass('fa').removeClass('fa-search')
                                  .removeClass('fas').removeClass('fa-times-circle')
                                  .addClass('fas').addClass('fa-plus-circle');
                $( "#breadcrumb" ).show();

                searcher.refreshScrubberVisibility();
            }

            searcher.submitHintList = function(page_num, search_curr_book)
            {
                page_num = page_num ? page_num : 0;
                search_curr_book = search_curr_book ? search_curr_book : false;

                var book_name = 'All';
                if(search_curr_book && $( "#tab_list" ).is(":visible"))
                {
                    var tab_elem = $('.tab_item_selected');
                    if(tab_elem && tab_elem.text() != "")
                    {
                        book_name = tab_elem.text();
                    }
                }

                updateResultList([], false);
                $("html, body").animate({ scrollTop: 0 }, "slow");

                // re-run the search to update the list of items shown
                $.ajax({
                    url:"../search?book="+book_name+"&page="+page_num,
                    type:"POST",
                    data:JSON.stringify(hint_list),
                    contentType:"application/json; charset=utf-8",
                }).done(function(out, textStatus)
                {
                    renderResult(false, out, textStatus, book_name, page_num);
                });
            }

            searcher.refreshPageSize = function()
            {
                if(searcher.pageUpdateTimerId != undefined)
                {
                    clearInterval(searcher.pageUpdateTimerId);
                    searcher.pageUpdateTimerId = undefined;
                }

                $( "#page_list" ).html("");
                if(searcher.curr_page >= 0)
                {
                    if(searcher.curr_page > 0)
                    {
                        $( "#page_list" ).append("<div class='page_item' id='prev_page'"+
                                                 " style='width: 20%'>Previous Page</div>");
                        if(searcher.has_next_page)
                        {
                            $( "#page_list" ).append("<div class='page_item' id='prev_page'"+
                                                     " style='width: 60%'></div>");
                            $( "#page_list" ).append("<div class='page_item' id='next_page'"+
                                                     " style='width: 20%; text-align: right;'>Next Page</div>");
                        }
                        else
                        {
                            $( "#page_list" ).append("<div class='page_item'"+
                                                     " style='width: 80%'></div>");
                        }
                    }
                    else
                    {
                        if(searcher.has_next_page)
                        {
                            $( "#page_list" ).append("<div class='page_item'"+
                                                     " style='width: 80%'></div>");
                            $( "#page_list" ).append("<div class='page_item' id='next_page'"+
                                                     " style='width: 20%; text-align: right;'>Next Page</div>");
                        }
                    }

                    $( "#next_page" ).off('click').click(
                        function(evt)
                        {
                            searcher.submitHintList(searcher.curr_page+1, true);
                        });

                    $( "#prev_page" ).off('click').click(
                        function(evt)
                        {
                            searcher.submitHintList(searcher.curr_page-1, true);
                        });
                }
            }

            searcher.refreshTabSize = function()
            {
                if(searcher.tabUpdateTimerId != undefined)
                {
                    clearInterval(searcher.tabUpdateTimerId);
                    searcher.tabUpdateTimerId = undefined;
                }

                $( "#tab_list" ).html("");
                $( "#tab_scrubber" ).hide();

                if(searcher.tabList)
                {
                    var minCount = -1;
                    var total = 0;
                    for(var k = 0; k < searcher.tabList.length; k++ )
                    {
                        if(minCount < 0 || searcher.tabList[k].count < minCount)
                        {
                            minCount = searcher.tabList[k].count;
                        }
                        total += searcher.tabList[k].count;
                    }

                    var allClass = (searcher.curr_book == undefined ||
                                    searcher.curr_book == 'All') ?
                                        'tab_item tab_item_selected' : 'tab_item';
                    $( "#tab_list" ).append("<div class='"+allClass+
                        "' style='width: 50px'>All</div>");

                    for(var k = 0; k < searcher.tabList.length; k++ )
                    {
                        var w = Math.max((searcher.tabList[k].count / total) *
                                         $("#sel_list").width(), 85);

                        var thisClass = 'tab_item';
                        if(searcher.curr_book == searcher.tabList[k].name)
                        {
                            thisClass += ' tab_item_selected';
                        }

                        $( "#tab_list" ).append("<div class='"+thisClass+
                            "' style='width: "+w+"px'>"+searcher.tabList[k].name+"</div>");
                    }

                    $( "#tab_scrubber" ).text(searcher.tabList.length+ " books");
                    $( ".tab_item" ).off('click').click(
                        function(evt)
                        {
                            var elem = $( this );
                            elem.siblings().removeClass('tab_item_selected')
                            elem.toggleClass('tab_item_selected');

                            searcher.submitHintList(undefined, true);
                        });

                    var totalWidth = 0;
                    $( ".tab_item" ).each(function( index ) {
                        totalWidth += $( this ).outerWidth();
                    });

                    if(totalWidth > ($( "#tab_list" ).width() + 20))
                    {
                        $( "#tab_scrubber" ).show();
                    }
                }
            }

            searcher.refreshScrubberVisibility = function()
            {
                if(searcher.hintUpdateTimerId != undefined)
                {
                    clearInterval(searcher.hintUpdateTimerId);
                    searcher.hintUpdateTimerId = undefined;
                }

                var isShown = false;
                if($( "#breadcrumb" ).is(":visible"))
                {
                    // check if arrows are needed
                    if(($("#search_container").width() -
                        $("#search_icon_holder").width() - 40) <
                        $("#breadcrumb").width())
                    {
                        isShown = true;
                    }
                }

                if(isShown)
                {
                    $("#scrubber").show();
                }
                else
                {
                    $("#scrubber").css("left", 0).hide();
                    $( "#breadcrumb" ).scrollLeft(0);
                }

                isShown = false;
                if($( "#tab_list" ).is(":visible"))
                {
                    var totalWidth = 0;
                    $( ".tab_item" ).each(function( index ) {
                        totalWidth += $( this ).width();
                    });

                    if(totalWidth > $( "#tab_list" ).width())
                    {
                        isShown = true;
                    }
                }

                if(isShown)
                {
                    $("#tab_scrubber").show();
                }
                else
                {
                    $("#tab_scrubber").css("left", 0).hide();
                    $( "#tab_list" ).scrollLeft(0);
                }
            }

            function addHint(title, desc, meta_search, isEnglish)
            {
                if(isEnglish)
                {
                    hint_list.push({english: meta_search, native: undefined});
                    html_str = ("<div class='hint-container'><div class='hint'>"+
                                "<i class='far fa-times-circle hint-delete'></i>"+
                                "<div class='hint_text'>"+
                                "<div class='hint_title'>"+title+"</div>"+
                                "<div class='hint_desc'>"+desc+"</div></div>");

                    if(meta_search.words[0].indexOf(' ') < 0)
                    {
                        html_str += ("<div class='hint_option_icon_inactive "+
                                     "hint_medaffinity'>etc</div>" +
                                     "<div class='hint_option_icon_inactive "+
                                     "hint_highaffinity'>alt</div>");

                        html_str += ("</div>"+
                                 "<div class='side-hint'>"+
                                 "<i class='add-concept-icon fas fa-plus-circle'>"+
                                 "</i></div></div>");
                    }

                    $( "#breadcrumb" ).append(html_str);
                }
                else
                {
                    hint_list.push({english: undefined, native: meta_search});
                    $( "#breadcrumb" ).append(
                        "<div class='hint-container'><div class='hint'>"+
                        "<i class='add-concept-icon fas fa-plus-circle'>"+
                        "</i></div>"+
                        "<div class='side-hint'>"+
                        "<div class='hint_text' style='padding-right: 5px'>"+
                        "<div class='hint_title'>"+title+"</div>"+
                        "<div class='hint_desc'>"+desc+"</div></div>"+
                        "<i class='far fa-times-circle hint-delete'></i>"+
                        "</div></div>");

                }

                // new hints mean that new events should be registered
                refreshHintEvents();
                refreshSideHintEvents();

                enableHintView();
            }

            function removeHintByIndex(idx)
            {
                $( "#word-info" ).hide();
                $( ".hint-container" ).eq(idx).remove();
                hint_list.splice(idx, 1);
                searcher.refreshScrubberVisibility();

                if(hint_list.length <= 0)
                {
                    updateResultList([], false);
                    enableTextSearch();
                }
                else
                {
                    searcher.submitHintList();
                }
            }

            function buildBaselessQueryString(idx)
            {
                var query_string = encodeURIComponent(
                    hint_list[idx].english.words[0])
                if(hint_list[idx].english.synonym)
                {
                    query_string += "&synonym";
                }
                if(hint_list[idx].english.similar)
                {
                    query_string += "&similar";
                }

                return query_string;
            }

            function addNativeSelection(idx)
            {
                pending_hint_elem = $( ".side-hint" ).eq(idx);
                pending_hint = hint_list[idx];

                updateResultList([], true);

                $.ajax({url: "../baseless-search?text="+
                    buildBaselessQueryString(idx)}
                ).done(function(out, textStatus)
                {
                    renderResult(true, out, textStatus);
                });
            }

            function addEnglishSelection(idx)
            {
                pending_hint_elem = $( ".hint" ).eq(idx);
                pending_hint = hint_list[idx];

                updateResultList([], true);

                $.ajax({
                    url: "../baseless-search?concord="+
                        encodeURIComponent(
                            hint_list[idx].native.concords[0])
                }).done(function(out, textStatus)
                {
                    renderResult(true, out, textStatus);
                });
            }

            function addToSearch(title, desc, meta_search, isEnglish)
            {
                addHint(title, desc, meta_search, isEnglish);
                searcher.submitHintList();
            }

            function changeExtra(extra_type, elem)
            {
                var idx = $( ".hint" ).index(elem.parent(".hint"));
                console.log("hint idx:"+idx)
                if(hint_list[idx].english[extra_type] == true)
                {
                    hint_list[idx].english[extra_type] = false;
                    elem.removeClass('hint_option_icon_active').addClass('hint_option_icon_inactive');
                }
                else
                {
                    hint_list[idx].english[extra_type] = true;
                    elem.removeClass('hint_option_icon_inactive').addClass('hint_option_icon_active');
                }

                searcher.submitHintList(undefined, true);
            }

            function addKeyWordClick()
            {
                $( ".kw" ).off('click').on('click',
                    function(event)
                    {
                        var needs_hide =
                            $( this )[0].classList.contains('clicked-word');
                        $( this ).siblings().removeClass('clicked-word')
                                            .addClass('kw');
                        $( this ).toggleClass('kw clicked-word');

                        if(needs_hide)
                        {
                            $( "#word-info" ).css(getLocatorPos()).hide();
                        }
                        else
                        {
                            kw_id = $( this ).attr('id').split("concord-")[1]
                            if(highlight_concords && highlight_concords[kw_id])
                            {
                                keyword_info = highlight_concords[kw_id];
                                $( "#details" ).html(
                                    keyword_info["description"]+
                                    "<div class='concept-row'>"+
                                    "<div class='left-concept'>"+
                                    "<i class='fab fa-pagelines'></i>"+
                                    keyword_info["native"]+
                                    "</div><div class='right-concept'>"+
                                    "<i class='fas fa-globe-americas'></i>"+
                                    keyword_info["word"]+"</div></div>")

                                $( ".left-concept" ).on('click',
                                    function(event)
                                    {
                                        addToSearch("Hebrew",
                                            highlight_concords[kw_id]["native"],
                                            {concords: [parseInt(kw_id)]}, false);
                                    });

                                $( ".right-concept" ).on('click',
                                    function(event)
                                    {
                                        english = highlight_concords[kw_id]["word"];
                                        addToSearch("English",
                                            english, {words: [english]}, true);
                                    });
                            }
                            else
                            {
                                $( "#details" ).html("")
                            }

                            $( "#word-info" ).css(getLocatorPos()).show();
                        }
                    }
                );
            }

            function updateResultList(items, isBaseless, highlight_verse, stats, curr_book, curr_page, has_next_page)
            {
                $( "#sel_list" ).html("");
                $( "#tab_list" ).html("");
                $( "#tab_list" ).scrollLeft(0);
                $( "#tab_scrubber" ).hide();

                searcher.tabList = [];
                searcher.curr_page = curr_page ? curr_page : 0;
                searcher.has_next_page = has_next_page ? has_next_page : false;
                searcher.refreshPageSize();

                var hasSetMainVerse = false;
                var hasSetTabList = false;
                if(highlight_verse != undefined)
                {
                    info = highlight_verse
                    hasSetMainVerse = true;
                    $( "#book_name" ).html(info.book);
                    $( "#chapter_verse" ).html(info.chapter+
                                           ":"+info.verse);
	                $( "#main_verse" ).html(info.text);

	                highlight_concords = info.concord_info;
                }
                result_list = items;
                for (var i = 0, len = result_list.length; i < len; i++)
                {
                    var info = result_list[i]
                    if(info.type == "category")
                    {
                        if(info.description == undefined)
                        {
                            info.description = "";
                        }

                        if(info.native == undefined)
                        {
                            info.native = "";
                        }

                        $( "#sel_list" ).append(
                            "<div class='search_res'>"+
                            "<div class='detail'>"+
                            "<div class='detail-top'>"+info.lang+"</div>"+
                            "<div class='detail-cat-bottom'>"+
                            info.common_book+"</div>"+
                            "</div><div class='msg'><div class='msg-top'>"+
                            info.native+"<span class='msg-top-desc'>"+
                            info.english+"</span></div>"+
                            "<div class='msg-bottom'>"+info.description+
                            "</div></div><div class='mini_chart_item'>"+
                            "<div class='stat-category'>Verses:</div>"+
                            "<div class='stat-border'>"+
                            "<div class='mini-stat-value'>"+
                            info.num_verse+
                            "</div></div></div></div>");
                    }
                    else
                    {
                        if(!hasSetMainVerse)
                        {
                            hasSetMainVerse = true;
                            $( "#book_name" ).html(info.book);
                            $( "#chapter_verse" ).html(info.chapter+
                                                   ":"+info.verse);
        	                $( "#main_verse" ).html(info.text);
                        }

                        if(!hasSetTabList)
                        {
                            hasSetTabList = true;
                            for(var j = 0; j < stats.length; j++)
                            {
                                if(stats[j].type == 'tabs')
                                {
                                    var minCount = -1;
                                    var total = 0;
                                    for(var k = 0; k < stats[j].data.length; k++ )
                                    {
                                        if(stats[j].type == 'tabs')
                                        {
                                            searcher.tabList = stats[j].data;
                                            searcher.curr_book = curr_book;
                                            searcher.refreshTabSize();

                                            for(var tabIdx = 0; tabIdx < searcher.tabList.length; tabIdx++ )
                                            {
                                                if(searcher.curr_book == searcher.tabList[tabIdx].name)
                                                {
                                                    var totalWidth = 0;
                                                    var currTabOffset = 0;
                                                    $( ".tab_item" ).each(function( index ) {
                                                        totalWidth += $( this ).outerWidth();

                                                        if(index < tabIdx)
                                                        {
                                                            currTabOffset += $( this ).outerWidth();
                                                        }
                                                    });

                                                    var diff = totalWidth - $( "#tab_list" ).width();
                                                    var perc = currTabOffset / $("#tab_list").width();
                                                    if(perc > 0.5)
                                                    {
                                                        perc = (currTabOffset + $("#tab_scrubber").outerWidth()) / $("#tab_list").width();
                                                    }
                                                    perc = Math.max(0, Math.min(1, perc));
                                                    $( "#tab_list" ).scrollLeft(perc * diff);
                                                    break;
                                                }
                                            }
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        $( "#sel_list" ).append(
                            "<div class='search_res'>"+
                            "<div class='detail'>"+
                            "<div class='detail-top'>"+info.book+"</div>"+
                            "<div class='detail-bottom'>"+info.chapter+
                            ":"+info.verse+"</div>"+
                            "</div><div class='msg'><div class='msg-top'></div>"+
                            "<div class='msg-bottom'>"+info.text+
                            "</div></div></div>");
                    }
                }

                $("#search_rooster").css("visibility",
                    (hint_list.length <= 0 || !isBaseless) ? "hidden" : "visible");
                $( ".search_res" ).click(function()
                {
                    searchResultClick(this);
                });

                if(result_list.length <= 0)
                {
                    drawChart([]);
                }
                else
                {
                    drawChart(stats);
                }

                addKeyWordClick();
            }

            function searchResultClick(item)
            {
                var idx = $( ".search_res" ).index(item);
                var info = result_list[idx];
                if(info.type == "category")
                {
                    result_list = [];
                    if(pending_hint != undefined)
                    {
                        if(info.lang == "english")
                        {
                            pending_hint.english = {words: info.words};

                            inner = ("<i class='far fa-times-circle hint-delete'></i>"+
                                    "<div class='hint_text'>"+
                                    "<div class='hint_title'>english</div>"+
                                    "<div class='hint_desc'>"+info.english+"</div>"+
                                    "</div>");

                            if(info.words[0].indexOf(' ') < 0)
                            {
                                inner += ("<div class='hint_option_icon_inactive "+
                                          "hint_medaffinity'>etc</div>" +
                                          "<div class='hint_option_icon_inactive "+
                                          "hint_highaffinity'>alt</div>");
                            }

                            pending_hint_elem.html(inner);
                        }
                        else
                        {
                            pending_hint.native = {concords: info.concord_ids};
                            pending_hint_elem.html(
                                "<div class='hint_text'>"+
                                "<div class='hint_title'>"+info.lang+"</div>"+
                                "<div class='hint_desc'>"+info.native+"</div>"+
                                "</div><i class='far fa-times-circle hint-delete'></i>");
                        }

                        refreshHintEvents();
                        refreshSideHintEvents();

                        pending_hint_elem = undefined;
                        pending_hint = undefined;
                    }
                    else
                    {
                        if(info.lang == "english")
                        {
                            addHint("English", info.english,
                                {words: info.words}, true);
                        }
                        else
                        {
                            addHint("Hebrew", info.native,
                                {concords: info.concord_ids}, false);
                        }
                    }

                    searcher.submitHintList();
                }
                else
                {
                    $.ajax({
                        url:"../verse?book="+encodeURIComponent(info.book)+
                            "&chapter="+encodeURIComponent(info.chapter)+
                            "&verse="+encodeURIComponent(info.verse),
                        type:"GET"
                    }).done(function(out, textStatus)
                    {
                        if(out)
                        {
                            $("html, body").animate({ scrollTop: 0 }, "slow");

                            $( "#word-info" ).hide();
                            $( "#book_name" ).html(info.book);
                            $( "#chapter_verse" ).html(info.chapter+
                                                   ":"+info.verse);
        	                $( "#main_verse" ).html(out.highlight_verse.text);

                            highlight_concords =
                                out.highlight_verse.concord_info;
        	                addKeyWordClick();
                        }
                    });
                }
            }

            function refreshHintEvents()
            {
                $( ".hint" ).off('mouseenter').on('mouseenter',
                    function(evt)
                    {
                        $(this).addClass('hint_hover');
                    });

                $( ".hint" ).off('mouseleave').on('mouseleave',
                    function(evt)
                    {
                        $(this).removeClass('hint_hover');
                    });


                $(".hint_medaffinity").off('click').click(
                    function(evt)
                    {
                        changeExtra('synonym', $(this));
                        return false;
                    });

                $(".hint_highaffinity").off('click').click(
                    function(evt)
                    {
                        changeExtra('similar', $(this));
                        return false;
                    });

                $( ".hint" ).find(".hint-delete").off('click').click(
                    function(evt)
                    {
                        var thisHint = $(this).parent();
                        var idx = $( ".hint" ).index(thisHint);
                        if(hint_list[idx].english == undefined)
                        {
                            addEnglishSelection(idx);
                        }
                        else if(hint_list[idx].native != undefined)
                        {
                            hint_list[idx].english = undefined;
                            thisHint.html("<i class='"+
                                "add-concept-icon fas fa-plus-circle'>"+
                                "</i>");
                            searcher.submitHintList(undefined, false);

                            thisHint.find(".add-concept-icon").off('click').click(
                                function(evt)
                                {
                                    var thisHint = $(this).parent();
                                    var idx = $( ".hint" ).index(thisHint);
                                    if(hint_list[idx].english == undefined)
                                    {
                                        evt.preventDefault();
                                        addEnglishSelection(idx);
                                    }
                                }
                            );

                            refreshHintEvents();
                        }
                        else
                        {
                            removeHintByIndex(idx);
                        }
                    }
                );

                $( ".hint" ).find(".add-concept-icon").off('click').click(
                    function(evt)
                    {
                        var thisHint = $(this).parent();
                        var idx = $( ".hint" ).index(thisHint);
                        if(hint_list[idx].english == undefined)
                        {
                            evt.preventDefault();
                            addEnglishSelection(idx);
                        }
                    }
                );
            }

            function refreshSideHintEvents()
            {
                $( ".side-hint" ).find(".hint-delete").off('click').click(
                    function(evt)
                    {
                        var thisHint = $(this).parent();
                        var idx = $( ".side-hint" ).index(thisHint);
                        if(hint_list[idx].english != undefined)
                        {
                            hint_list[idx].native = undefined;
                            thisHint.html("<i class='"+
                                "add-concept-icon fas fa-plus-circle'></i>");

                            thisHint.find(".add-concept-icon").off('click').click(
                                function(evt)
                                {
                                    var thisHint = $(this).parent();
                                    var idx = $( ".side-hint" ).index(thisHint);
                                    if(hint_list[idx].native == undefined)
                                    {
                                        evt.preventDefault();
                                        addNativeSelection(idx);
                                    }
                                }
                            );

                            if(hint_list.length == 1)
                            {
                                addNativeSelection(idx);
                            }
                            else
                            {
                                searcher.submitHintList(undefined, false);
                            }
                        }
                        else
                        {
                            removeHintByIndex(idx);
                        }
                    }
                );

                $( ".side-hint" ).find(".add-concept-icon").off('click').click(
                    function(evt)
                    {
                        var thisHint = $(this).parent();
                        var idx = $( ".side-hint" ).index(thisHint);
                        if(hint_list[idx].native == undefined)
                        {
                            evt.preventDefault();
                            addNativeSelection(idx);
                        }
                    }
                );
            }

            function renderResult(isBaseless, out, textStatus, curr_book, curr_page)
            {
                $( "#sel_list" ).html("");
                if (typeof window.orientation === 'undefined')
                {
                    $('#question').focus();
                }

                if(textStatus == "success" && out.data && out.data.length > 0)
                {
                    if(isBaseless)
                    {
                        // some baseless searches don't return verses, so we will account for that now
                        isBaseless = out.data[0].book == undefined;
                    }

                    $( "#word-info" ).hide();
                    updateResultList(out.data, isBaseless,
                                     out.highlight_verse,
                                     out.stats, curr_book,
                                     curr_page,
                                     out.next_page);
                }
                else
                {
                    if(isBaseless && hint_list.length > 0)
                    {
                        $("#search_rooster").css("visibility", "visible");
                    }

                    $( '#error' ).css("display", "block");

                    var basicTimeline = anime.timeline();
                    basicTimeline.complete = function(anim) {
                        $( '#error' ).css("display", "none");
                    }
                    basicTimeline
                        .add({
                            targets: ['#error'],
                            opacity: '1',
                            duration: 400,
                            easing: 'linear'
                        })
                        .add({
                            targets: ['#error'],
                            opacity: '0',
                            duration: 1350,
                            easing: 'linear'
                        })
                }
            }

            function doSearch(q)
            {
                // at the moment, nothing to search when hints are in bar
                if(hint_list.length > 0)
                {
                    return;
                }

                $( '#question' ).blur();

                result_list = [];
                $( "#sel_list" ).html("");

                $.ajax({
                    url: "../baseless-search?text="+encodeURIComponent(q)
                }).done(function(out, textStatus)
                {
                    if(textStatus == "success")
                    {
                        addHint("english", q, {words: [q]}, true);
                        idx = hint_list.length-1;
                        pending_hint = hint_list[idx];
                        pending_hint_elem = $( ".side-hint" ).eq(idx);
                        $( '#question' ).val("");
                    }
                    renderResult(true, out, textStatus);

                }).fail(function()
                {
                    if (typeof window.orientation === 'undefined')
                    {
                        $('#question').focus();
                    }
                });
            }

            function getLocatorPos()
            {
                el = $( '.clicked-word' )[0]
                for (var lx=0, ly=0; el != null;
                     lx += el.offsetLeft,
                     ly += el.offsetTop,
                     el = el.offsetParent);

                desiredHeight = 150;
                topY = ly - desiredHeight - 10
                low_pt = $('#verse_container')[0].offsetTop;

                if(topY < 10)
                {
                    offset = (10 - topY);
                    desiredHeight -= offset;
                    topY += offset;
                }
                else if(topY > (low_pt - 170))
                {
                    offset = (topY - (low_pt - 170));
                    desiredHeight += offset;
                    topY -= offset;
                }

                $( "#line-container" ).css("height", desiredHeight);
                $( "#pointer-line" )[0].y2.baseVal.value = desiredHeight;

                return {top: topY,
                        left: lx + ($( '.clicked-word' ).width() / 2)};
            }

            $( "#question" ).keydown(
                function(evt)
                {
                    var q = $( this ).val().trim();
                    if(q == "")
                    {
                        $( this ).css("color", "black");
                    }
                    else if(q.length == 1 && evt.keyCode == 8)  //backspace
                    {
                        $( this ).css("color", "grey");
                    }
                }
            );

            $('input[type=search]').on('search', function ()
            {
                var q = $( this ).val().trim();
                if(hint_list.length <= 0)
                {
                    if(q != "")
                    {
                        doSearch(q);
                    }
                }
                else
                {
                    addToSearch("English", q, {words: [q]}, true);
                }
            });

            $( "#question" ).click(function()
            {
                if($( this ).val().trim() == "")
                {
                    $( this ).css("color", "black");
                }
            });

            $( "#search_rooster" ).click(function()
            {
                searcher.submitHintList();
            })

            $( window ).resize(function()
            {
                $( "#word-info" ).css(getLocatorPos());

                if(searcher.hintUpdateTimerId != undefined)
                {
                    clearInterval(searcher.hintUpdateTimerId);
                }

                if(searcher.tabUpdateTimerId != undefined)
                {
                    clearInterval(searcher.tabUpdateTimerId);
                }

                if(searcher.pageUpdateTimerId != undefined)
                {
                    clearInterval(searcher.pageUpdateTimerId);
                }

                searcher.hintUpdateTimerId = setInterval(
                    searcher.refreshScrubberVisibility, 750);

                searcher.tabUpdateTimerId = setInterval(
                    searcher.refreshTabSize, 750);

                searcher.pageUpdateTimerId = setInterval(
                    searcher.refreshPageSize, 750);
            });

            // Callback that creates and populates a data table,
            // instantiates the pie chart, passes in the data and
            // draws it.
            function drawChart(chart_info)
            {
                for(var item = 0; item < chart_info.length; item++)
                {
                    var info = chart_info[item];
                    switch(info.type)
                    {
                        case "doughnut":
                            var ctx = document.getElementById('chart'+(item+1)).getContext('2d');
                            var donut_data = {datasets: [{data: [], backgroundColor: []}], labels: []};
                            var just_update = (active_charts[item] != undefined);
                            var info_len = info.data.length;

                            if(just_update)
                            {
                                // reset/create the arrays
                                var arr = active_charts[item].data;
                                arr.labels = [];
                                arr.datasets[0].data = [];
                                arr.datasets[0].backgroundColor = [];
                            }

                            for(var inner = 0; inner < info_len; inner++)
                            {
                                var arr;
                                if(just_update)
                                {
                                    arr = active_charts[item].data.datasets[0];
                                    active_charts[item].data.labels[inner] = info.data[inner].key;
                                }
                                else
                                {
                                    arr = donut_data.datasets[0];
                                    donut_data.labels[inner] = info.data[inner].key;
                                }

                                arr.data[inner] = info.data[inner].value;
                                bg_alpha = 1.0 - (inner / info_len);
                                arr.backgroundColor.push(colorStringify(bg_alpha));
                            }

                            if(just_update)
                            {
                                active_charts[item].update();
                            }
                            else
                            {
                                active_charts[item] = new Chart(
                                    ctx,
                                    {
                                        type: info.type,
                                        data: donut_data,
                                        options: {
                                            responsive: false,
                                            legend: { position: "right", labels: {fontFamily: "Lato"} },
                                            layout: { padding: { top: 13 }}
                                        }
                                    });
                            }
                            break;

                        case "stat":
                            active_charts[item] = $( "#chart"+(item+1) );
                            active_charts[item].html("<div class='stat-category'>"+
                                                  info.data[0].key+
                                                  "</div>"+
                                                  "<div class='stat-border'>"+
                                                  "<div class='stat-value'>"+
                                                  info.data[0].value+
                                                  "</div></div>");
                            break;
                    }
                }

                for(var item = chart_info.length; item < active_charts.length; item++)
                {
                    if(typeof active_charts[item].destroy !== "undefined")
                    {
                        active_charts[item].destroy();
                    }
                    else if(typeof active_charts[item].html !== "undefined")
                    {
                        active_charts[item].html("");
                    }
                    active_charts.splice(item, 1);

                    item--;
                }
            }

            highlight_concords = [];
            result_list = [];
            hint_list = [];
            active_charts = [];
            pending_hint = undefined;
            pending_hint_elem = undefined;

            $( "#word-info" ).hide();
            $( "#breadcrumb" ).hide();
            $( "#scrubber" ).draggable(
                {
                    axis: "x",
                    containment: "parent",
                    drag: function( event, ui )
                    {
                        var totalWidth = 0;
                        $( ".hint-container" ).each(function( index ) {
                            totalWidth += $( this ).width();
                        });

                        var diff = Math.max((totalWidth - $("#breadcrumb").width()) * 1.6, 75);
                        var perc = (ui.offset.left - $("#search_container").offset().left) / ($("#search_container").width() * 0.8);
                        $( "#breadcrumb" ).scrollLeft(Math.max(0, Math.min(1, perc)) * diff);
                    }
                }
            );
            $( "#tab_scrubber" ).draggable(
                {
                    axis: "x",
                    containment: "parent",
                    drag: function( event, ui )
                    {
                        var totalWidth = 0;
                        $( ".tab_item" ).each(function( index ) {
                            totalWidth += $( this ).outerWidth();
                        });

                        var diff = totalWidth - $( "#tab_list" ).width();
                        var offset = ui.offset.left - $("#tab_list").offset().left;
                        var perc = offset / $("#tab_list").width();
                        if(perc > 0.5)
                        {
                            perc = (offset + $("#tab_scrubber").outerWidth()) / $("#tab_list").width();
                        }
                        perc = Math.max(0, Math.min(1, perc));
                        $( "#tab_list" ).scrollLeft(perc * diff);
                    }
                }
            );

            $( "#scrubber" ).hide();
            $( "#tab_scrubber").hide();

            var colors = [[85, 65, 106],// purple
                          [29, 34, 88], // blue
                          [24, 71, 71], // green
                          [21, 48, 62], // teal
                          [139, 0, 0],  // red
                          [121, 71, 40],// brown
                          ];
            var lightColors = [[150, 129, 213], // purple
                               [129, 183, 213], // blue
                               [43, 128, 108],  // green
                               [177, 229, 212], // teal
                               [220, 190, 190], // red
                               [213, 169, 130], // brown
                              ];
            var offColors = [[107, 87, 199], // purple
                             [42, 62, 127],  // blue
                             [30, 90, 76],   // green
                             [34, 102, 99],  // teal
                             [194, 150, 150],// red
                             [199, 139, 86],// brown
                            ];
            var useColor = Math.floor(Math.random() * colors.length);

            function colorStringify(alpha)
            {
                return "rgba("+colors[useColor][0]+", "+
                               colors[useColor][1]+", "+
                               colors[useColor][2]+", "+
                               alpha+")";
            }

            function lightColorStringify(alpha)
            {
                return "rgba("+lightColors[useColor][0]+", "+
                               lightColors[useColor][1]+", "+
                               lightColors[useColor][2]+", "+
                               alpha+")";
            }

            function offColorStringify(alpha)
            {
                return "rgba("+offColors[useColor][0]+", "+
                               offColors[useColor][1]+", "+
                               offColors[useColor][2]+", "+
                               alpha+")";
            }

            var root = document.documentElement;
            root.style.setProperty('--main-color', colorStringify(1));
            root.style.setProperty('--main-color-med', colorStringify(0.5));
            root.style.setProperty('--main-color-low', colorStringify(0.2));
            root.style.setProperty('--main-color-light', lightColorStringify(0.55));
            root.style.setProperty('--off-color', offColorStringify(0.85));

            $.ajax({
                url:"../random-verse",
                type:"GET"
            }).done(function(out, textStatus)
            {
                if(out)
                {
                    info = out.highlight_verse;
                    $( "#book_name" ).html(info.book);
                    $( "#chapter_verse" ).html(info.chapter+
                                           ":"+info.verse);
	                $( "#main_verse" ).html(info.text);

                    highlight_concords = info.concord_info;
	                addKeyWordClick();
                }
            }).fail(function(out, textStatus)
            {
                $( "#book_name" ).html("John");
                $( "#chapter_verse" ).html("3:16");
                $( "#main_verse" ).html("For God so loved the world that He \
                    gave His only Son, that whoever believes in Him shall not \
                    perish, but have eternal life.");
            });
        })();
        </script>
    </body>
</html>